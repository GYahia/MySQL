-- Active: 1736824156068@@localhost@3306@311_service_requests
-- Data downloaded from Calgary website for the date of 17 Jan 2026
-- Source: https://data.calgary.ca/Services-and-Amenities/311-Service-Requests/iahh-g8bj/about_data
-- Use the newly created database
USE 311_service_requests;

SHOW COLUMNS FROM service_requests_clean_v3;
----------------------------------------------------------------------------------
-- DATA  EXPLORATION
----------------------------------------------------------------------------------
----------------------------------------------------------------------------------
-- Geographical Analysis
----------------------------------------------------------------------------------

----------------------------------------------------------------------------------
-- Using Table "service_requests_analysis"
----------------------------------------------------------------------------------

-- Which combinations of service type + community have the most issues that come back within 30 days?

WITH firsts AS (
  SELECT
    sr1.service_request_id,
    sr1.service_name,
    sr1.comm_name,
    sr1.point,
    sr1.requested_date
  FROM service_requests_analysis sr1
  WHERE NOT EXISTS (
    SELECT 1
    FROM service_requests_analysis sr0
    WHERE sr0.point = sr1.point
      AND sr0.service_name = sr1.service_name
      AND sr0.service_request_id <> sr1.service_request_id
      AND sr0.requested_date < sr1.requested_date
      AND sr0.requested_date >= sr1.requested_date - INTERVAL 30 DAY
  )
),
firsts_scored AS (
  SELECT
    f.comm_name,
    f.service_name,
    CASE WHEN EXISTS (
      SELECT 1
      FROM service_requests_analysis sr2
      WHERE sr2.point = f.point
        AND sr2.service_name = f.service_name
        AND sr2.service_request_id <> f.service_request_id
        AND sr2.requested_date > f.requested_date
        AND sr2.requested_date <= f.requested_date + INTERVAL 30 DAY
    ) THEN 1 ELSE 0 END AS reoccurs_30d
  FROM firsts f
)
SELECT 
  comm_name,
  service_name,
  COUNT(*) AS first_occurrences,
  SUM(reoccurs_30d) AS first_occurrences_with_30d_repeat,
  ROUND(SUM(reoccurs_30d) / COUNT(*) * 100, 2) AS recurrence_rate_pct
FROM firsts_scored
GROUP BY comm_name, service_name
ORDER BY first_occurrences_with_30d_repeat DESC
LIMIT 10;

/*
GREENVIEW INDUSTRIAL PARK	WATR - Industrial Monitoring Inquiry	195	164	84.10
WOODBINE					Bylaw - Tree - Shrub Infraction	180	143	79.44
GLENDALE					Bylaw - Tree - Shrub Infraction	161	131	81.37
WILLOW PARK					Bylaw - Tree - Shrub Infraction	150	124	82.67
THORNCLIFFE					Bylaw - Tree - Shrub Infraction	140	102	72.86
AUBURN BAY					CFD - Operation Birthdays	100	100	100.00
MAHOGANY					CFD - Operation Birthdays	94	94	100.00
BOWNESS						WATS - Water Pressure Issues	122	92	75.41
BOWNESS						WATS - Water Outage	111	90	81.08
VALLEY RIDGE				WATS - Water Outage	110	87	79.09
*/

-- Hotspot concentration (Pareto) of 30-day repeating first occurrences by point

WITH firsts AS (
  SELECT
    sr1.service_request_id,
    sr1.service_name,
    sr1.point,
    sr1.requested_date
  FROM service_requests_analysis sr1
  WHERE NOT EXISTS (
    SELECT 1
    FROM service_requests_analysis sr0
    WHERE sr0.point = sr1.point
      AND sr0.service_name = sr1.service_name
      AND sr0.service_request_id <> sr1.service_request_id
      AND sr0.requested_date < sr1.requested_date
      AND sr0.requested_date >= sr1.requested_date - INTERVAL 30 DAY
  )
),
firsts_with_repeat AS (
  SELECT
    f.point
  FROM firsts f
  WHERE EXISTS (
    SELECT 1
    FROM service_requests_analysis sr2
    WHERE sr2.point = f.point
      AND sr2.service_name = f.service_name
      AND sr2.service_request_id <> f.service_request_id
      AND sr2.requested_date > f.requested_date
      AND sr2.requested_date <= f.requested_date + INTERVAL 30 DAY
  )
),
point_counts AS (
  SELECT
    point,
    COUNT(*) AS reoccurring_first_occurrences
  FROM firsts_with_repeat
  GROUP BY point
),
ranked AS (
  SELECT
    point,
    reoccurring_first_occurrences,
    SUM(reoccurring_first_occurrences) OVER () AS total_reoccurring,
    SUM(reoccurring_first_occurrences) OVER (
      ORDER BY reoccurring_first_occurrences DESC, point
    ) AS running_reoccurring
  FROM point_counts
)
SELECT
  point,
  reoccurring_first_occurrences,
  running_reoccurring,
  total_reoccurring,
  ROUND(running_reoccurring / total_reoccurring * 100, 2) AS cumulative_pct
FROM ranked
ORDER BY reoccurring_first_occurrences DESC
LIMIT 200;

8/*
POINT (-114.06959221074 51.047270199675)	4151	4151	571942	0.73
POINT (-114.187826026643 51.083359442425)	3430	7581	571942	1.33
POINT (-114.093646376658 51.057268028314)	3136	10717	571942	1.87
POINT (-114.162595259525 51.096001313234)	3120	13837	571942	2.42
POINT (-114.035072483805 51.050566763066)	3118	16955	571942	2.96
POINT (-114.162275611864 51.071107878926)	3053	20008	571942	3.50
POINT (-114.039175832326 51.059658452148)	2994	23002	571942	4.02
POINT (-114.066709443959 51.117582291839)	2932	25934	571942	4.53
POINT (-114.14395321027 51.124587846242)	2888	28822	571942	5.04
POINT (-114.079026310069 51.056419204793)	2868	31690	571942	5.54
POINT (-113.971230283867 51.037847718454)	2856	34546	571942	6.04
POINT (-114.115155739639 51.055058817012)	2847	37393	571942	6.54
POINT (-114.012584731192 50.992096131355)	2797	40190	571942	7.03
POINT (-114.053698219636 50.972409209652)	2701	42891	571942	7.50
POINT (-113.996783821473 51.044541013835)	2656	45547	571942	7.96
POINT (-114.084911140805 51.131643985322)	2633	48180	571942	8.42
POINT (-113.961479995234 50.917137251386)	2617	50797	571942	8.88
POINT (-114.158164615208 51.109413833961)	2601	53398	571942	9.34
POINT (-114.05518879725601 51.037437926217)	2564	55962	571942	9.78
POINT (-114.073756821499 50.903303329478)	2557	58519	571942	10.23
POINT (-113.993150510368 51.022462990084)	2547	61066	571942	10.68
POINT (-114.135914500141 51.096066204486)	2541	63607	571942	11.12
POINT (-114.094651621635 51.072661693566)	2529	66136	571942	11.56
POINT (-114.057266517276 51.013257096808)	2421	68557	571942	11.99
POINT (-113.970068163647 51.088773412719)	2412	70969	571942	12.41
POINT (-114.051322869438 50.939809070436)	2399	73368	571942	12.83
POINT (-113.969988023308 51.059545401295)	2381	75749	571942	13.24
POINT (-113.957817281387 50.892705346575)	2371	78120	571942	13.66
POINT (-114.145493740992 51.043277392563)	2195	80315	571942	14.04
POINT (-113.947516195404 51.045865617282)	2192	82507	571942	14.43
POINT (-114.101467687736 51.042958639874)	2183	84690	571942	14.81
POINT (-114.019119965195 51.034140523505)	2159	86849	571942	15.18
POINT (-114.04204857668 50.901555104863)	2102	88951	571942	15.55
POINT (-114.04253245854 51.036411166547)	2100	91051	571942	15.92
POINT (-114.06161026890402 51.059521420883)	2071	93122	571942	16.28
POINT (-114.152862596234 51.01552804934)	2043	95165	571942	16.64
POINT (-114.158541417804 51.058257995028)	2036	97201	571942	16.99
POINT (-114.207876270297 51.045130968851)	2013	99214	571942	17.35
POINT (-114.068083237139 51.033158395427)	1993	101207	571942	17.70
POINT (-113.945247606329 50.922051675383)	1960	103167	571942	18.04
POINT (-114.094962509765 51.137732844893)	1908	105075	571942	18.37
POINT (-114.083200893081 50.957773565131)	1905	106980	571942	18.70
POINT (-114.112181903017 51.090125817883)	1896	108876	571942	19.04
POINT (-114.179195894374 51.022860957412)	1891	110767	571942	19.37
POINT (-114.074894864056 51.033930231501)	1881	112648	571942	19.70
POINT (-114.08355230578 51.005045758895)	1856	114504	571942	20.02
POINT (-113.967606589538 51.021051172755)	1847	116351	571942	20.34
POINT (-114.065551835538 51.018173613136)	1845	118196	571942	20.67
POINT (-113.961029731958 51.105254134535)	1835	120031	571942	20.99
POINT (-114.08335089480701 50.972214404313)	1834	121865	571942	21.31
POINT (-114.13533705624 51.059942702335)	1822	123687	571942	21.63
POINT (-114.100794741538 51.01594846688301)	1803	125490	571942	21.94
POINT (-114.20757830589602 51.132632565563)	1796	127286	571942	22.26
POINT (-114.131701908734 51.030129392795)	1790	129076	571942	22.57
POINT (-114.022482205646 51.02285932043)	1757	130833	571942	22.88
POINT (-114.061044520077 51.074245240422)	1739	132572	571942	23.18
POINT (-114.11842246883901 51.029705434695)	1736	134308	571942	23.48
POINT (-113.927793918828 51.059520123186)	1725	136033	571942	23.78
POINT (-114.07602784635401 51.074230696377)	1720	137753	571942	24.09
POINT (-114.082182330983 50.940963833547)	1696	139449	571942	24.38
POINT (-114.068779421169 51.103099554741)	1693	141142	571942	24.68
POINT (-114.11521349389 51.137719036393)	1691	142833	571942	24.97
POINT (-114.10206934847102 51.026807031815)	1685	144518	571942	25.27
POINT (-114.217258259663 51.112664609468)	1684	146202	571942	25.56
POINT (-114.060338376198 50.985381707008)	1672	147874	571942	25.85
POINT (-114.01190367638202 50.948445044984)	1671	149545	571942	26.15
POINT (-114.240790659013 51.121889851117004)	1655	151200	571942	26.44
POINT (-114.009087704597 50.925406722045)	1648	152848	571942	26.72
POINT (-113.945622522669 51.130573242135)	1642	154490	571942	27.01
POINT (-113.946764955772 51.074259757628)	1642	156132	571942	27.30
POINT (-114.081307514569 50.898696863448)	1642	157774	571942	27.59
POINT (-113.945374990249 51.103306383786)	1635	159409	571942	27.87
POINT (-114.175605232152 51.130973523397)	1632	161041	571942	28.16
POINT (-114.020233883908 50.926573610262)	1608	162649	571942	28.44
POINT (-113.988181270218 50.914880843208)	1606	164255	571942	28.72
POINT (-113.970058118649 51.074239973669)	1605	165860	571942	29.00
POINT (-114.057614948384 50.915638474664)	1605	167465	571942	29.28
POINT (-114.088063406263 51.159711011076006)	1598	169063	571942	29.56
POINT (-114.056201945188 50.956619266549)	1593	170656	571942	29.84
POINT (-114.083835394766 51.021363353696)	1577	172233	571942	30.11
POINT (-114.077365201777 50.986889392907)	1576	173809	571942	30.39
POINT (-113.946767736659 51.088794585093)	1573	175382	571942	30.66
POINT (-114.049050973244 51.08651539849)	1567	176949	571942	30.94
POINT (-113.958387117131 51.117913725938)	1565	178514	571942	31.21
POINT (-114.127429287735 51.063906687036)	1560	180074	571942	31.48
POINT (-114.158443443507 51.044154718216)	1557	181631	571942	31.76
POINT (-114.19627989529101 51.104270088384)	1552	183183	571942	32.03
POINT (-114.112451127992 51.171117591305)	1548	184731	571942	32.30
POINT (-114.208458271936 51.026824120988)	1540	186271	571942	32.57
POINT (-113.97999151788702 50.878202389903)	1537	187808	571942	32.84
POINT (-114.100489190214 51.034131244477)	1537	189345	571942	33.11
POINT (-114.206168211978 51.059719609151)	1537	190882	571942	33.37
POINT (-114.050815101465 51.047064884967)	1533	192415	571942	33.64
POINT (-114.01789266805 50.975977670109)	1525	193940	571942	33.91
POINT (-113.946717348392 51.059691849527)	1524	195464	571942	34.18
POINT (-114.152686529025 51.024203413126)	1508	196972	571942	34.44
POINT (-114.087779721498 51.047969311337)	1507	198479	571942	34.70
POINT (-114.04185548061001 51.075324957807)	1499	199978	571942	34.96
POINT (-114.028539401913 50.92119720014)	1498	201476	571942	35.23
POINT (-114.105728156306 51.06319785211)	1494	202970	571942	35.49
POINT (-114.078197287675 51.062712450882)	1491	204461	571942	35.75
POINT (-114.062068985496 51.088022395583)	1490	205951	571942	36.01
POINT (-114.132865129752 51.160266707482)	1478	207429	571942	36.27
POINT (-114.11532492862 50.91871439337301)	1466	208895	571942	36.52
POINT (-114.183643473696 51.119158241438)	1464	210359	571942	36.78
POINT (-114.129628653745 50.939610852216)	1461	211820	571942	37.04
POINT (-114.216562668401 51.015499752197)	1446	213266	571942	37.29
POINT (-113.926948486479 51.103352770689)	1444	214710	571942	37.54
POINT (-114.07990104744 51.092355774905)	1444	216154	571942	37.79
POINT (-114.24589901587 51.144214953688)	1435	217589	571942	38.04
POINT (-114.115129022304 51.074216599416)	1425	219014	571942	38.29
POINT (-114.05314340697402 51.164906330332)	1417	220431	571942	38.54
POINT (-114.119609232562 51.15193708420501)	1411	221842	571942	38.79
POINT (-114.013325241169 51.060827713741)	1407	223249	571942	39.03
POINT (-113.93400207797302 51.117940163039)	1406	224655	571942	39.28
POINT (-114.129633403832 50.99977294369)	1396	226051	571942	39.52
POINT (-114.219921351493 51.142705841683)	1382	227433	571942	39.77
POINT (-113.929459756862 50.917810216339)	1376	228809	571942	40.01
POINT (-114.182930890079 51.058345065702)	1374	230183	571942	40.25
POINT (-114.177579629411 51.047403251082)	1359	231542	571942	40.48
POINT (-114.10635317279402 50.956000123579)	1338	232880	571942	40.72
POINT (-114.106343648496 50.941119997755)	1327	234207	571942	40.95
POINT (-114.152740197664 51.033378041374)	1320	235527	571942	41.18
POINT (-114.005997812989 50.857614404243)	1318	236845	571942	41.41
POINT (-114.126642797077 51.04520482018901)	1315	238160	571942	41.64
POINT (-114.085027886241 51.029967076465)	1314	239474	571942	41.87
POINT (-114.136282147874 51.048609671664)	1311	240785	571942	42.10
POINT (-113.997338140443 51.034155684722)	1304	242089	571942	42.33
POINT (-114.140704788108 51.17561697278)	1303	243392	571942	42.56
POINT (-114.129609099121 50.969739206709)	1299	244691	571942	42.78
POINT (-113.981989023988 50.99416606569)	1289	245980	571942	43.01
POINT (-114.02565000091901 50.884599966913)	1266	247246	571942	43.23
POINT (-113.968771739973 51.049237369631)	1256	248502	571942	43.45
POINT (-114.107148836011 51.040722505631)	1254	249756	571942	43.67
POINT (-114.086500314441 51.036481810867)	1253	251009	571942	43.89
POINT (-114.129616070747 50.957148743073006)	1230	252239	571942	44.10
POINT (-114.052777977324 51.147677586031)	1222	253461	571942	44.32
POINT (-114.183916846492 51.144535953053)	1210	254671	571942	44.53
POINT (-113.926851043815 51.081459464825)	1205	255876	571942	44.74
POINT (-114.10972655248402 50.89945485662201)	1200	257076	571942	44.95
POINT (-114.112246566894 51.001422376521)	1196	258272	571942	45.16
POINT (-114.13736158459 51.018991792178)	1196	259468	571942	45.37
POINT (-114.152021658531 51.15998962983)	1180	260648	571942	45.57
POINT (-114.08490366384501 50.91704529217801)	1176	261824	571942	45.78
POINT (-114.10240136091302 51.083504232298)	1175	262999	571942	45.98
POINT (-113.950956719842 50.951244506166)	1173	264172	571942	46.19
POINT (-113.945622522669 51.130573242134)	1167	265339	571942	46.39
POINT (-113.979991517887 50.878202389903)	1124	266463	571942	46.59
POINT (-113.992777567852 50.961483457792)	1116	267579	571942	46.78
POINT (-114.065520106506 51.052826999718)	1115	268694	571942	46.98
POINT (-113.924526958877 50.895958497484)	1107	269801	571942	47.17
POINT (-114.034678452994 50.957639474378)	1099	270900	571942	47.36
POINT (-114.071941914798 50.885075634965)	1094	271994	571942	47.56
POINT (-114.072820937689 51.053606993492)	1078	273072	571942	47.74
POINT (-114.077355421758 50.997829629949)	1078	274150	571942	47.93
POINT (-114.057464648114 51.094862194321)	1070	275220	571942	48.12
POINT (-114.088063406263 51.159711011075)	1068	276288	571942	48.31
POINT (-113.946764955772 51.074259757631)	1054	277342	571942	48.49
POINT (-114.08937896534401 51.0843391716)	1052	278394	571942	48.68
POINT (-114.022568260238 50.938220919477004)	1051	279445	571942	48.86
POINT (-113.946767736659 51.08879458506)	1048	280493	571942	49.04
POINT (-114.055188797256 51.037437926217)	1047	281540	571942	49.23
POINT (-114.073620449524 51.012993800994)	1046	282586	571942	49.41
POINT (-114.251163893403 51.095378003784)	1044	283630	571942	49.59
POINT (-114.17705006381301 51.063839441978)	1042	284672	571942	49.77
POINT (-114.240790659013 51.121889851117)	1037	285709	571942	49.95
POINT (-114.063147448083 51.026328115315)	1032	286741	571942	50.13
POINT (-113.958374560746 51.156126734974)	1030	287771	571942	50.31
POINT (-114.061610268906 51.059521420883)	1029	288800	571942	50.49
POINT (-113.958387117131 51.117913725942)	1027	289827	571942	50.67
POINT (-114.06139543185 51.158203848304)	1021	290848	571942	50.85
POINT (-113.924526958877 50.895958497483)	1020	291868	571942	51.03
POINT (-114.146684192313 51.145092839729)	1015	292883	571942	51.21
POINT (-114.019119965195 51.034140523504)	1014	293897	571942	51.39
POINT (-114.076027846354 51.074230696377)	1012	294909	571942	51.56
POINT (-114.053143406974 51.164906330299)	999	295908	571942	51.74
POINT (-113.945374990249 51.103306383785)	998	296906	571942	51.91
POINT (-113.970044778726 51.103384585419)	997	297903	571942	52.09
POINT (-113.991700569993 51.074221599517)	996	298899	571942	52.26
POINT (-113.94784935522 50.874163785696)	986	299885	571942	52.43
POINT (-114.083350894807 50.972214404313)	984	300869	571942	52.60
POINT (-114.131701908734 51.030129392804)	978	301847	571942	52.78
POINT (-113.970058118649 51.074239973667)	974	302821	571942	52.95
POINT (-114.100794741538 51.015948466883)	960	303781	571942	53.11
POINT (-114.079893774799 51.14377568311)	959	304740	571942	53.28
POINT (-114.179195894375 51.022860957412)	957	305697	571942	53.45
POINT (-114.061044520078 51.074245240422)	951	306648	571942	53.62
POINT (-114.11215380042401 50.966764686286)	947	307595	571942	53.78
POINT (-113.991711864004 51.089901299573)	944	308539	571942	53.95
POINT (-114.011903676382 50.948445044984)	941	309480	571942	54.11
POINT (-114.017726360644 51.07193261122)	937	310417	571942	54.27
POINT (-114.124744281618 51.003088943466)	937	311354	571942	54.44
POINT (-114.131534859373 50.990480564409)	932	312286	571942	54.60
POINT (-114.083200893081 50.957773565143)	930	313216	571942	54.76
POINT (-114.209087210747 51.071889436591)	925	314141	571942	54.93
POINT (-114.133076187082 51.070391317576)	924	315065	571942	55.09
POINT (-114.119609232562 51.151937084205)	920	315985	571942	55.25
POINT (-114.166339399989 51.175335680829)	920	316905	571942	55.41
POINT (-114.112451127993 51.17108535645)	916	317821	571942	55.57
POINT (-113.92785764419702 51.044981778175)	915	318736	571942	55.73
*/




